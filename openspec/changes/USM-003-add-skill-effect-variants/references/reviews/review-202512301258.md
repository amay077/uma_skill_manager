# Review: USM-003-add-skill-effect-variants

- **Date**: 2025/12/30 12:58 JST
- **Reviewer**: spec-reviewer (Claude)
- **Iteration**: 3 / 10
- **Result**: PASS

## Summary

proposal は前回のレビュー指摘を反映し、Impact セクションに `skill-parser` が追加された。openspec validate --strict がパスしており、フォーマット・内容ともに品質基準を満たしている。effect_order と is_demerit による多段発動効果の表現は明確で、将来の 3 段以上の発動にも対応可能な拡張性のある設計となっている。

## Issues

### Issue 1: USM-002 への参照が不正確

- **Severity**: Minor
- **Location**: `specs/skill-effect-variants/spec.md`
- **Line**: 148-150
- **Description**: 「既存テストの成功」シナリオで「USM-001 で作成したテストスイート」と記載されているが、前回レビューでは「USM-002」と記載されていた（現在の spec では USM-001 に修正済み）。openspec/specs を確認したところ、実際に存在するのは `skill-parser` のみであり USM-001 に対応している。この参照は正確。
- **Suggestion**: 指摘なし。正しく修正されている。

### Issue 2: DB スキーマの UNIQUE 制約が未明記（継続）

- **Severity**: Minor
- **Location**: `specs/skill-effect-variants/spec.md`
- **Line**: 79-87
- **Description**: `skill_effect_variants` テーブルの定義で、`(skill_id, variant_index, effect_order)` の組み合わせに対する UNIQUE 制約の有無が明示されていない。データの整合性を保証するためには、この制約を明記することが望ましい。
- **Suggestion**: DB スキーマの Scenario に以下を追加:
  ```markdown
  - UNIQUE(skill_id, variant_index, effect_order)（同一スキル・バリアント・発動順序の重複防止）
  ```

### Issue 3: effect_order の最大値が未定義

- **Severity**: Minor
- **Location**: `specs/skill-effect-variants/spec.md`
- **Line**: 65-69
- **Description**: 「3 段以上の発動効果への対応」シナリオで effect_order=0, 1, 2 の例があるが、effect_order の最大値や上限についての記載がない。実装時に INTEGER の範囲内であれば問題ないが、仕様として上限を明記するか「上限なし」と明記することで曖昧さを排除できる。
- **Suggestion**: Overview セクションまたは該当 Scenario に「effect_order に上限はなく、N 段発動に対応」と補足するか、現実的な上限（例: 10）を定義する。

## Checklist

### A. フォーマット検証
- [x] Requirement に SHALL/MUST が含まれている
- [x] 各 Requirement に Scenario がある
- [x] MODIFIED 要件に元の内容が完全に記載（該当なし: すべて ADDED）
- [x] proposal.md に Why/What Changes/Impact セクションがある
- [x] openspec validate --strict がパス

### B. 内容面レビュー
- [x] 要件間に矛盾がない
- [x] 曖昧な表現がない
- [x] シナリオがテスト可能（具体的な値・条件が明示されている）
- [x] エッジケース・エラーケースが網羅されている（既存 skill-parser のエラーハンドリングを継承）
- [x] 影響範囲が妥当（skill-database, skill-parser が明記済み）
- [x] ビジネスロジックが整合
- [x] プロジェクトドキュメントと整合

## Changes from Previous Review

前回（Iteration 1）のレビューからの改善点:

1. **Issue 1 解消**: proposal.md の Impact セクションに `skill-parser（パーサー拡張）` が追加された
2. **USM-001 参照**: spec.md の「既存テストの成功」シナリオで USM-001 への参照が明確化された

## Conclusion

この proposal は OpenSpec の品質基準を満たしており、実装に進めることを推奨します。残存する Minor Issues（UNIQUE 制約の明記、effect_order の上限定義）は実装時に解決可能な軽微な改善点であり、proposal の承認を妨げるものではありません。

前回レビューからの主要な指摘事項（Impact セクションへの skill-parser 追加）が適切に反映されており、仕様の完成度は十分です。
