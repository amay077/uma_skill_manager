# Review: USM-012_add-saved-search

- **Date**: 2026/01/03 21:42 JST
- **Reviewer**: spec-reviewer (Claude)
- **Iteration**: 1 / 10
- **Result**: FAIL

## Summary

proposal の基本構造は整っており、フォーマット検証は概ね通過している。しかし、内容面で重要な問題がいくつか存在する。特に、条件名の入力方法、空文字の条件名に対する処理、localStorage アクセス失敗時のエラーハンドリングなど、エッジケースや異常系のシナリオが不足している。

## Critical Issues

指摘事項なし

## Major Issues

### Issue 1: 条件名入力の具体的な UI/UX が未定義

- **Severity**: Major
- **Location**: `specs/saved-search/spec.md`
- **Line**: 14-18
- **Description**: 「保存ボタンをクリックし、条件名を入力する」とあるが、条件名の入力方法（モーダルダイアログ、インライン入力、プロンプト等）が明示されていない。テスト可能性に影響する。
- **Suggestion**: 以下のいずれかを明記する:
  - `**THEN** 条件名入力ダイアログが表示される`
  - または `**THEN** ブラウザの prompt ダイアログが表示される`

### Issue 2: 空文字・空白のみの条件名に対するバリデーションがない

- **Severity**: Major
- **Location**: `specs/saved-search/spec.md`
- **Line**: 9-34
- **Description**: 条件名が空文字や空白のみの場合の挙動が定義されていない。ユーザーが誤って空の名前で保存しようとした場合の処理が不明確。
- **Suggestion**: 以下のシナリオを追加する:
  ```markdown
  #### Scenario: Empty condition name validation（空の条件名バリデーション）
  
  - **GIVEN** ユーザーが保存ボタンをクリックした
  - **WHEN** 条件名を空文字または空白のみで入力する
  - **THEN** エラーメッセージが表示される
  - **AND** 保存は実行されない
  ```

### Issue 3: localStorage アクセス失敗時のエラーハンドリングがない

- **Severity**: Major
- **Location**: `specs/saved-search/spec.md`
- **Description**: localStorage がブラウザで無効化されている場合や、ストレージ容量上限に達した場合のエラーハンドリングが未定義。プライベートブラウジング等で localStorage が使用できないケースがある。
- **Suggestion**: 以下のシナリオを追加する:
  ```markdown
  #### Scenario: localStorage unavailable（localStorage 利用不可）
  
  - **GIVEN** ブラウザの localStorage が利用できない（プライベートモード等）
  - **WHEN** 保存ボタンをクリックする
  - **THEN** エラーメッセージが表示される
  - **AND** 保存機能が無効化または代替手段が提示される
  ```

### Issue 4: 保存キャンセル時の挙動が未定義

- **Severity**: Major
- **Location**: `specs/saved-search/spec.md`
- **Line**: 14-18
- **Description**: 条件名入力時にキャンセルした場合（ダイアログを閉じる、ESC キー等）の挙動が定義されていない。
- **Suggestion**: 以下のシナリオを追加する:
  ```markdown
  #### Scenario: Cancel save operation（保存操作のキャンセル）
  
  - **GIVEN** 条件名入力ダイアログが表示されている
  - **WHEN** ユーザーがキャンセルする（ESC キーまたはキャンセルボタン）
  - **THEN** 保存は実行されない
  - **AND** ダイアログが閉じる
  ```

## Minor Issues

### Issue 5: 保存データ形式の savedAt フィールドのフォーマットが曖昧

- **Severity**: Minor
- **Location**: `specs/saved-search/spec.md`
- **Line**: 28-33
- **Description**: `savedAt: string` とあるが、ISO 8601 形式なのかタイムスタンプなのか不明確。
- **Suggestion**: 具体的なフォーマットを明記する（例: `savedAt: string (ISO 8601 形式: "2026-01-03T21:42:00.000Z")`）

### Issue 6: 最大件数到達時のエラーメッセージ内容が未指定

- **Severity**: Minor
- **Location**: `specs/saved-search/spec.md`
- **Line**: 20-25
- **Description**: 「エラーメッセージが表示される」とあるが、具体的なメッセージ内容やユーザーへの対処法の提示が未定義。
- **Suggestion**: 具体的なメッセージ例を追記する（例: `"保存上限（10件）に達しています。不要な条件を削除してください。"`）

### Issue 7: 削除確認ダイアログのボタン表記が未指定

- **Severity**: Minor
- **Location**: `specs/saved-search/spec.md`
- **Line**: 88-94
- **Description**: 「確認ダイアログが表示される」とあるが、ボタンの表記（「削除」/「キャンセル」等）が未指定。
- **Suggestion**: 上書き確認と同様に「はい」/「いいえ」または「削除」/「キャンセル」を明記する。

### Issue 8: 条件復元時に存在しない条件種別（DB 側で削除されたフィルタ等）の処理が未定義

- **Severity**: Minor
- **Location**: `specs/saved-search/spec.md`
- **Line**: 72-82
- **Description**: 保存時と復元時でシステムのフィルタ項目が変更された場合（将来のバージョンアップ等）の互換性処理が未定義。
- **Suggestion**: マイグレーション方針を検討し、不明な条件は無視するか警告を表示する方針を明記することを推奨。

## Checklist

### A. フォーマット検証
- [x] Requirement に SHALL/MUST が含まれている
- [x] 各 Requirement に Scenario がある
- [N/A] MODIFIED 要件に元の内容が完全に記載（新規 spec のため該当なし）
- [x] proposal.md に Why/What Changes/Impact がある
- [x] openspec validate --strict がパス

### B. 内容面レビュー
- [x] 要件間に矛盾がない
- [ ] 曖昧な表現がない（条件名入力方法、エラーメッセージ内容に曖昧さあり）
- [ ] シナリオがテスト可能（UI/UX の具体的な挙動が不足）
- [ ] エッジケース・エラーケースが網羅されている（空文字、localStorage 失敗、キャンセル等が不足）
- [x] 影響範囲が妥当
- [x] ビジネスロジックが整合
- [x] プロジェクトドキュメントと整合（用語集は存在しないが、既存 spec との整合性あり）

## Conclusion

上記の指摘事項（特に Major の4件）を解消してから再レビューが必要です。

主な改善点:
1. 条件名入力の具体的な UI/UX（ダイアログ形式等）を明記する
2. 空文字・空白のみの条件名に対するバリデーションシナリオを追加する
3. localStorage 利用不可時のエラーハンドリングシナリオを追加する
4. 保存操作キャンセル時のシナリオを追加する
