# Review: USM-003-add-skill-effect-variants

- **Date**: 2025/12/30 12:31 JST
- **Reviewer**: spec-reviewer (Claude)
- **Iteration**: 1 / 10
- **Result**: PASS

## Summary

- Validation: PASS
- Critical Issues: 0件
- Major Issues: 0件
- Minor Issues: 2件

proposal は OpenSpec のフォーマット要件を満たしており、仕様としての完成度も高い。軽微な改善点として、既存 spec（skill-parser）との影響関係の明確化と、一部シナリオの網羅性向上が推奨される。

## Critical Issues

なし

## Major Issues

なし

## Minor Issues

### Issue 1: 既存 skill-parser spec への影響が Impact に未記載

- **Severity**: Minor
- **Location**: `proposal.md`
- **Line**: 23-27
- **Description**: Impact セクションの Affected specs に `skill-database` のみ記載されているが、パーサー拡張は既存の `skill-parser` spec にも影響を与える可能性がある。skill-parser の「効果パラメータの抽出」要件が拡張される形になるため、この関連性を明記すべき。
- **Suggestion**: Impact セクションを以下のように更新:
  ```markdown
  - **Affected specs**: skill-database（テーブル追加）, skill-parser（パーサー拡張）
  ```

### Issue 2: エラーケースのシナリオが不足

- **Severity**: Minor
- **Location**: `specs/skill-effect-variants/spec.md`
- **Line**: 65-89
- **Description**: 「パーサーの複数効果対応」要件にはパース成功シナリオのみ記載されており、以下のエラーケースが網羅されていない:
  - 不正な `A->B` 形式（片方が空など）
  - variant_index の重複
  - 効果パラメータが全く抽出できないバリアント
- **Suggestion**: エラーハンドリングのシナリオを追加するか、既存 skill-parser のエラーハンドリング要件を参照する形で対応を明記する。

## Checklist

### A. フォーマット検証
- [x] Requirement に SHALL/MUST が含まれている
- [x] 各 Requirement に Scenario がある
- [x] proposal.md に Why/What Changes/Impact セクションがある
- [x] tasks.md にチェックリスト形式のタスクがある
- [x] openspec validate --strict がパス

### B. 内容面レビュー
- [x] 要件間に矛盾がない
- [x] 曖昧な表現がない
- [x] シナリオがテスト可能（具体的な値・条件が明示されている）
- [ ] エッジケース・エラーケースが網羅されている（Minor Issue #2）
- [x] 影響範囲が妥当（Minor Issue #1 で改善推奨）
- [x] ビジネスロジックが整合
- [x] プロジェクトドキュメントと整合

## Recommendations

1. **skill-parser との関係整理**: 今回の変更で skill-parser spec に MODIFIED 要件を追加するか、skill-effect-variants が skill-parser を拡張する独立した capability として扱うかを明確にすることを推奨。現在の構成（独立した新 spec）は合理的だが、proposal.md の Impact で関係性を明記すべき。

2. **後方互換性テストの具体化**: tasks.md の「6.4 後方互換性テスト」について、spec.md の「既存テストの成功」シナリオでは USM-002 のテストスイート参照となっているが、USM-002 が存在しない場合は USM-001 のテストスイートを参照するか、具体的なテストケースを spec に記載することを検討。

3. **DB スキーマの制約追加**: `skill_effect_variants` テーブルの定義で、`UNIQUE(skill_id, variant_index)` 制約の明記を検討。現在は「variant_index ... 0 が最大効果」との記載があるが、DB レベルでの一意性制約の有無が不明確。

## Conclusion

この proposal は OpenSpec の品質基準を満たしており、実装に進めることを推奨します。Minor Issues は実装時または次回イテレーションで対応可能な軽微な改善点であり、proposal の承認を妨げるものではありません。
